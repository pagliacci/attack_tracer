<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        .wanna-be-console {
            display: table;
            background-color: black;
        }

        .wanna-be-console ul {
            max-height: 200px;
            overflow: auto;
        }

        .wanna-be-console .events-list li,
        .wanna-be-console .headers {
            display: table-row;
        }

        .wanna-be-console span {
            display: table-cell;
            padding: 10px;
            color: white;
            font-family: "Lucida Console", Monaco, monospace;
        }

        #map {
            width: 1600px;
            height: 800px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>

</head>

<body>
    <div class="wanna-be-console">
        <ul class="events-list">
        </ul>
    </div>
    <div id="map"></div>
    <script>
        const headers = [
            'time',
            'attack type',
            'source country',
            'source city',
            'source ip',
            'destination country',
            'destination city',
            'destination ip',
            'login',
            'password'
        ];
        let socket = io.connect('/');
        let existingEvents = [];
        let createLi = function (data) {
            let li = document.createElement('li');
            li.innerHTML =
                `<span>${data.time}</span>
                <span>${data.attack_type}</span>
                <span>${data.src_country}</span>
                <span>${data.src_city}</span>
                <span>${data.src_ip}</span>
                <span>${data.dst_country}</span>
                <span>${data.dst_city}</span>
                <span>${data.dst_ip}</span>
                <span>${data.login}</span>
                <span>${data.password}</span>`;

            return li;
        };
        let updateList = function () {
            let list = document.getElementsByClassName('events-list')[0];
            list.innerHTML = '';
            headers.forEach(h => {
                const header = document.createElement('span');
                header.innerHTML = h.toUpperCase();
                list.appendChild(header);
            });
            let listElements = existingEvents.map(e => createLi(e));
            listElements.forEach(e => list.appendChild(e));
        };

        mapboxgl.accessToken = 'pk.eyJ1IjoiYmFyYWJ1bGxrbyIsImEiOiJjamUwNjBienQxaTQzMnBvaHZ4OTlsc2t5In0._nrXaI2sCkGLXbIw6GgvdQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v9'
        });

        socket.on('existingLog', function (log) {
            existingEvents.push(...log.log);
            updateList();
            console.log(log);
        });
        socket.on('update', function (data) {
            let d = data.data;
            existingEvents.push(d);
            updateList();
            let src = [d.src_latitude, d.src_longitude];
            let dst = [d.dst_latitude, d.dst_longitude];

            qwe(src, dst);
            console.log(d);
        });

        var geojson = {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                        [0, 0]
                    ]
                }
            }]
        };

        var qweasd = 0;

        function qwe(src, dst) {
            qweasd++;

            var route = {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "geometry": {
                        "type": "LineString",
                        "coordinates": [
                            src,
                            dst
                        ]
                    }
                }]
            };

            // qweasd++;
            var arc = [];

            var point = {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": origin
                    }
                }]
            };

            var lineDistance = turf.lineDistance(route.features[0], 'kilometers');

            // Draw an arc between the `origin` & `destination` of the two points
            for (var i = 0; i < lineDistance; i++) {
                var segment = turf.along(route.features[0], i / 1000 * lineDistance, 'kilometers');
                arc.push(segment.geometry.coordinates);
            }

            route.features[0].geometry.coordinates = arc;

            // map.addSource('route', {
            //     "type": "geojson",
            //     "data": route
            // });

            map.addSource('point' + qweasd, {
                "type": "geojson",
                "data": point
            });

            // map.addLayer({
            //     "id": "route",
            //     "source": "route",
            //     "type": "line",
            //     "paint": {
            //         "line-width": 2,
            //         "line-color": "#007cbf"
            //     }
            // });

            map.addLayer({
                "id": "point" + qweasd,
                "source": "point" + qweasd,
                "type": "symbol",
                "layout": {
                    "icon-image": "airport-15",
                    "icon-rotate": 90,
                    "icon-allow-overlap": true
                }
            });

            var counter = 0;

            animate();

            function animate(timestamp) {
                // Update point geometry to a new position based on counter denoting
                // the index to access the arc.
                point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[counter];

                // Update the source with this new data.
                map.getSource('point' + qweasd).setData(point);

                // Request the next frame of animation so long as destination has not
                // been reached.
                let currentCoordinates = point.features[0].geometry.coordinates;
                if (currentCoordinates[0] !== dst[0] && currentCoordinates[1] !== dst[1]) {
                    requestAnimationFrame(animate);
                }
                else {
                    map.removeLayer('point' + qweasd);
                }

                counter = counter + 5;
            }
        }
    </script>
</body>

</html>